name: Deploy Terral Social to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        name: Deploy via Docker
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to VPS
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  command_timeout: 30m
                  envs: DATABASE_URL,REDIS_URL,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,NEXT_PUBLIC_APP_URL,MERCADOPAGO_ACCESS_TOKEN,MERCADOPAGO_PUBLIC_KEY
                  script: |
                      # Exportar vari√°veis de ambiente para o script
                      export DATABASE_URL="${{ secrets.DATABASE_URL }}"
                      export REDIS_URL="${{ secrets.REDIS_URL }}"
                      export POSTGRES_USER="${{ secrets.POSTGRES_USER }}"
                      export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
                      export POSTGRES_DB="${{ secrets.POSTGRES_DB }}"
                      export NEXT_PUBLIC_APP_URL="${{ secrets.NEXT_PUBLIC_APP_URL }}"
                      export MERCADOPAGO_ACCESS_TOKEN="${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}"
                      export MERCADOPAGO_PUBLIC_KEY="${{ secrets.MERCADOPAGO_PUBLIC_KEY }}"

                      # Baixar script de deploy profissional
                      curl -fsSL https://raw.githubusercontent.com/efpatti/terralsocial/main/scripts/professional-deploy.sh -o /tmp/deploy.sh
                      chmod +x /tmp/deploy.sh

                      # Executar deploy
                      /tmp/deploy.sh

            - name: Deployment Summary
              if: success()
              run: |
                  echo "‚úÖ Deploy realizado com sucesso!"
                  echo "üöÄ Aplica√ß√£o dispon√≠vel em: http://${{ secrets.VPS_HOST }}:3000"
                  echo "üìù Confira os logs acima para detalhes"

            - name: Deployment Failed
              if: failure()
              run: |
                  echo "‚ùå Deploy falhou!"
                  echo "üìã Verifique os logs acima para identificar o problema"
                  echo "üîß Comandos de debug no VPS:"
                  echo "   docker compose logs -f"
                  echo "   docker ps -a"
                  exit 1
