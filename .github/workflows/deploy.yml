name: Deploy Terral Social to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        name: Deploy via Docker
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to VPS
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  command_timeout: 30m
                  script: |
                      set -e

                      # ConfiguraÃ§Ãµes
                      DEPLOY_DIR="/opt/terralsocial"
                      REPO_URL="https://github.com/efpatti/terralsocial.git"
                      BRANCH="main"

                      echo "========================================="
                      echo "ğŸš€ Deploy do Terral Social"
                      echo "========================================="

                      # 1. Verificar prÃ©-requisitos
                      echo "ğŸ“‹ Verificando prÃ©-requisitos..."

                      if ! command -v git &> /dev/null; then
                          echo "âŒ Git nÃ£o encontrado. Instalando..."
                          sudo apt-get update && sudo apt-get install -y git
                      fi

                      if ! command -v docker &> /dev/null; then
                          echo "âŒ Docker nÃ£o estÃ¡ instalado!"
                          exit 1
                      fi

                      if ! docker compose version &> /dev/null; then
                          echo "âŒ Docker Compose V2 nÃ£o estÃ¡ disponÃ­vel!"
                          exit 1
                      fi

                      echo "âœ… PrÃ©-requisitos OK"

                      # 2. Gerenciar repositÃ³rio
                      echo ""
                      echo "ğŸ“‚ Gerenciando repositÃ³rio..."

                      if [ ! -d "$DEPLOY_DIR" ]; then
                          echo "ğŸ“¥ Clonando repositÃ³rio..."
                          sudo mkdir -p "$DEPLOY_DIR"
                          sudo chown -R $USER:$USER "$DEPLOY_DIR"
                          git clone "$REPO_URL" "$DEPLOY_DIR"
                      elif [ ! -d "$DEPLOY_DIR/.git" ]; then
                          echo "âš ï¸ DiretÃ³rio existe mas nÃ£o Ã© git. Removendo e clonando..."
                          sudo rm -rf "$DEPLOY_DIR"
                          sudo mkdir -p "$DEPLOY_DIR"
                          sudo chown -R $USER:$USER "$DEPLOY_DIR"
                          git clone "$REPO_URL" "$DEPLOY_DIR"
                      fi

                      cd "$DEPLOY_DIR"

                      # 3. Atualizar cÃ³digo
                      echo ""
                      echo "ğŸ”„ Atualizando cÃ³digo..."

                      if ! git diff-index --quiet HEAD -- 2>/dev/null; then
                          git stash save "Auto-stash $(date +%Y%m%d_%H%M%S)"
                      fi

                      BEFORE=$(git rev-parse HEAD 2>/dev/null || echo "none")
                      git fetch origin "$BRANCH"
                      git reset --hard "origin/$BRANCH"
                      AFTER=$(git rev-parse HEAD)

                      echo "âœ… CÃ³digo atualizado: ${AFTER:0:7}"

                      # 4. Configurar .env
                      echo ""
                      echo "âš™ï¸ Configurando variÃ¡veis de ambiente..."

                      cat > .env << 'ENV_EOF'
                      DATABASE_URL=${{ secrets.DATABASE_URL }}
                      REDIS_URL=${{ secrets.REDIS_URL }}
                      NODE_ENV=production
                      NEXT_TELEMETRY_DISABLED=1
                      NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
                      POSTGRES_USER=${{ secrets.POSTGRES_USER }}
                      POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
                      POSTGRES_DB=${{ secrets.POSTGRES_DB }}
                      MERCADOPAGO_ACCESS_TOKEN=${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
                      MERCADOPAGO_PUBLIC_KEY=${{ secrets.MERCADOPAGO_PUBLIC_KEY }}
                      ENV_EOF

                      echo "âœ… Arquivo .env criado"

                      # 5. Parar containers
                      echo ""
                      echo "ğŸ›‘ Parando containers existentes..."
                      docker compose down --remove-orphans 2>/dev/null || echo "Nenhum container rodando"

                      # 6. Limpar recursos
                      echo ""
                      echo "ğŸ§¹ Limpando recursos Docker..."
                      docker system prune -f || true

                      # 7. Build e start
                      echo ""
                      echo "ğŸ”¨ Buildando e iniciando containers..."
                      echo "â³ Isso pode levar alguns minutos..."

                      if ! docker compose up -d --build; then
                          echo "âŒ Falha no build!"
                          docker compose logs --tail=50
                          exit 1
                      fi

                      echo "âœ… Containers iniciados"

                      # 8. Aguardar healthchecks
                      echo ""
                      echo "â³ Aguardando healthchecks (atÃ© 90s)..."

                      for i in {1..18}; do
                          sleep 5
                          if docker exec terralsocial-postgres pg_isready -U ${POSTGRES_USER:-terral} &> /dev/null; then
                              echo "âœ… PostgreSQL pronto apÃ³s $((i*5))s"
                              break
                          fi
                          echo "â³ Aguardando PostgreSQL... ($((i*5))s/90s)"
                      done

                      echo "â³ Aguardando Next.js iniciar..."
                      sleep 20

                      # 9. Migrations
                      echo ""
                      echo "ğŸ—„ï¸ Executando migrations..."
                      docker exec terralsocial-nextjs npx prisma db push --skip-generate 2>&1 || echo "âš ï¸ Migrations jÃ¡ aplicadas"

                      # 10. Verificar saÃºde
                      echo ""
                      echo "ğŸ¥ Verificando saÃºde dos containers..."
                      echo ""
                      docker compose ps
                      echo ""

                      # Verificar Next.js
                      if docker ps -q -f name=terralsocial-nextjs -f status=running | grep -q .; then
                          echo "âœ… Next.js estÃ¡ rodando"
                          echo ""
                          echo "ğŸ“‹ Logs do Next.js:"
                          docker logs terralsocial-nextjs --tail 20
                      else
                          echo "âŒ Next.js NÃƒO estÃ¡ rodando!"
                          docker logs terralsocial-nextjs --tail 100 2>&1
                          exit 1
                      fi

                      echo ""

                      # Verificar PostgreSQL
                      if docker ps -q -f name=terralsocial-postgres -f status=running | grep -q .; then
                          echo "âœ… PostgreSQL estÃ¡ rodando"
                      else
                          echo "âš ï¸ PostgreSQL nÃ£o estÃ¡ rodando"
                      fi

                      # Verificar Redis
                      if docker ps -q -f name=terralsocial-redis -f status=running | grep -q .; then
                          echo "âœ… Redis estÃ¡ rodando"
                      else
                          echo "âš ï¸ Redis nÃ£o estÃ¡ rodando"
                      fi

                      # 11. Teste de conectividade
                      echo ""
                      echo "ğŸŒ Testando conectividade..."
                      sleep 5

                      if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
                          echo "âœ… AplicaÃ§Ã£o estÃ¡ respondendo"
                      else
                          echo "âš ï¸ AplicaÃ§Ã£o pode nÃ£o estar pronta ainda"
                      fi

                      # 12. Resumo
                      echo ""
                      echo "========================================="
                      echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
                      echo "========================================="
                      echo "ğŸ“¦ Commit: ${AFTER:0:7}"
                      echo "ğŸ“… Data: $(date '+%Y-%m-%d %H:%M:%S')"
                      echo "ğŸŒ URL: http://localhost:3000"
                      echo "========================================="

            - name: Deployment Summary
              if: success()
              run: |
                  echo "âœ… Deploy realizado com sucesso!"
                  echo "ğŸš€ AplicaÃ§Ã£o disponÃ­vel em: http://${{ secrets.VPS_HOST }}:3000"
                  echo "ğŸ“ Confira os logs acima para detalhes"

            - name: Deployment Failed
              if: failure()
              run: |
                  echo "âŒ Deploy falhou!"
                  echo "ğŸ“‹ Verifique os logs acima para identificar o problema"
                  echo "ğŸ”§ Comandos de debug no VPS:"
                  echo "   docker compose logs -f"
                  echo "   docker ps -a"
                  exit 1
