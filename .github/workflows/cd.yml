name: CD - Deploy to Production

on:
    workflow_run:
        workflows: ["CI - Build and Test"]
        types:
            - completed
        branches:
            - main

permissions:
    contents: read
    statuses: write
    deployments: write

concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: false

env:
    DEPLOY_DIR: "/opt/terralsocial"
    REPO_URL: "https://github.com/efpatti/terralsocial.git"
    BRANCH: "main"
    BACKUP_RETENTION_DAYS: 7

jobs:
    # Job 1: Pre-deployment checks
    pre-deployment-checks:
        name: Pre-Deployment Checks
        runs-on: ubuntu-latest
        timeout-minutes: 15
        if: github.event.workflow_run.conclusion == 'success'

        outputs:
            should-deploy: ${{ steps.validate.outputs.should-deploy }}
            backup-id: ${{ steps.backup-prep.outputs.backup-id }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Validate deployment conditions
              id: validate
              run: |
                  echo "Validando condi√ß√µes de deployment..."
                  echo "‚úÖ CI Pipeline passou com sucesso"
                  echo "‚úÖ Branch: main"
                  echo "should-deploy=true" >> $GITHUB_OUTPUT

            - name: Prepare backup ID
              id: backup-prep
              run: |
                  BACKUP_ID="backup-$(date +%Y%m%d-%H%M%S)"
                  echo "backup-id=$BACKUP_ID" >> $GITHUB_OUTPUT
                  echo "üì¶ Backup ID: $BACKUP_ID"

            - name: Create deployment status
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.repos.createDeployment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          ref: 'main',
                          environment: 'production',
                          required_contexts: [],
                          production_environment: true,
                          auto_merge: false
                      })

    # Job 2: Database backup
    database-backup:
        name: Database Backup
        runs-on: ubuntu-latest
        timeout-minutes: 20
        needs: pre-deployment-checks
        if: needs.pre-deployment-checks.outputs.should-deploy == 'true'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Backup database
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  timeout: 5m
                  command_timeout: 15m
                  script: |
                      set -euo pipefail
                      BACKUP_DIR="/opt/backups/terralsocial"
                      BACKUP_ID="${{ needs.pre-deployment-checks.outputs.backup-id }}"
                      BACKUP_FILE="$BACKUP_DIR/$BACKUP_ID.sql"

                      echo "========================================="
                      echo "üíæ Iniciando backup do banco de dados"
                      echo "========================================="

                      # Criar diret√≥rio de backups
                      sudo mkdir -p "$BACKUP_DIR"
                      sudo chown -R $USER:$USER "$BACKUP_DIR"

                      # Fazer backup
                      echo "‚è≥ Fazendo dump do PostgreSQL..."
                      docker exec terralsocial-postgres pg_dump \
                          -U ${{ secrets.POSTGRES_USER }} \
                          ${{ secrets.POSTGRES_DB }} > "$BACKUP_FILE" || {
                          echo "‚ùå Falha ao fazer backup!"
                          exit 1
                      }

                      # Comprimir
                      gzip "$BACKUP_FILE"
                      BACKUP_SIZE=$(du -h "$BACKUP_FILE.gz" | cut -f1)

                      echo "‚úÖ Backup criado: $BACKUP_ID.sql.gz ($BACKUP_SIZE)"

                      # Limpar backups antigos (manter √∫ltimos 7 dias)
                      echo "üßπ Limpando backups antigos..."
                      find "$BACKUP_DIR" -name "backup-*.sql.gz" -mtime +${{ env.BACKUP_RETENTION_DAYS }} -delete

                      echo "========================================="

    # Job 3: Verificar pr√©-requisitos
    check-prerequisites:
        name: Check Prerequisites
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: database-backup

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Verify VPS access and requirements
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  timeout: 2m
                  command_timeout: 5m
                  script: |
                      set -euo pipefail
                      echo "========================================="
                      echo "‚úÖ Verificando pr√©-requisitos"
                      echo "========================================="

                      # Verificar Git
                      if ! command -v git &> /dev/null; then
                          echo "‚ùå Git n√£o encontrado!"
                          exit 1
                      fi
                      echo "‚úÖ Git: $(git --version)"

                      # Verificar Docker
                      if ! command -v docker &> /dev/null; then
                          echo "‚ùå Docker n√£o est√° instalado!"
                          exit 1
                      fi
                      echo "‚úÖ Docker: $(docker --version)"

                      # Verificar Docker Compose
                      if ! docker compose version &> /dev/null; then
                          echo "‚ùå Docker Compose V2 n√£o est√° dispon√≠vel!"
                          exit 1
                      fi
                      echo "‚úÖ Docker Compose: $(docker compose version)"

                      # Verificar espa√ßo em disco
                      DISK_USAGE=$(df -h {{ env.DEPLOY_DIR }} | awk 'NR==2 {print $5}' | sed 's/%//')
                      if [ "$DISK_USAGE" -gt 80 ]; then
                          echo "‚ö†Ô∏è Aviso: Disco com $DISK_USAGE% de uso"
                      else
                          echo "‚úÖ Espa√ßo em disco OK: $DISK_USAGE%"
                      fi

                      echo "========================================="
                      echo "‚úÖ Todos os pr√©-requisitos OK!"
                      echo "========================================="

    # Job 4: Atualizar reposit√≥rio
    update-repository:
        name: Update Repository
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: check-prerequisites

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Clone/Update repository
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  timeout: 3m
                  command_timeout: 10m
                  script: |
                      set -euo pipefail
                      echo "========================================="
                      echo "üìÇ Gerenciando reposit√≥rio"
                      echo "========================================="

                      # Criar ou atualizar reposit√≥rio
                      if [ ! -d "${{ env.DEPLOY_DIR }}" ]; then
                          echo "üì• Clonando reposit√≥rio..."
                          sudo mkdir -p "${{ env.DEPLOY_DIR }}"
                          sudo chown -R $USER:$USER "${{ env.DEPLOY_DIR }}"
                          git clone "${{ env.REPO_URL }}" "${{ env.DEPLOY_DIR }}"
                      elif [ ! -d "${{ env.DEPLOY_DIR }}/.git" ]; then
                          echo "‚ö†Ô∏è Diret√≥rio existe mas n√£o √© git. Removendo e clonando..."
                          sudo rm -rf "${{ env.DEPLOY_DIR }}"
                          sudo mkdir -p "${{ env.DEPLOY_DIR }}"
                          sudo chown -R $USER:$USER "${{ env.DEPLOY_DIR }}"
                          git clone "${{ env.REPO_URL }}" "${{ env.DEPLOY_DIR }}"
                      fi

                      cd "${{ env.DEPLOY_DIR }}"

                      # Atualizar c√≥digo
                      echo "üîÑ Atualizando c√≥digo..."
                      if ! git diff-index --quiet HEAD -- 2>/dev/null; then
                          git stash save "Auto-stash $(date +%Y%m%d_%H%M%S)"
                      fi

                      git fetch origin "${{ env.BRANCH }}"
                      git reset --hard "origin/${{ env.BRANCH }}"
                      COMMIT=$(git rev-parse HEAD)

                      echo "‚úÖ C√≥digo atualizado: ${COMMIT:0:7}"
                      echo "‚úÖ Commit: $(git log -1 --pretty=format:'%h - %s')"
                      echo "========================================="

    # Job 5: Configurar vari√°veis de ambiente
    setup-environment:
        name: Setup Environment
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: update-repository

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure environment variables
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  timeout: 2m
                  command_timeout: 5m
                  script: |
                      set -euo pipefail
                      echo "========================================="
                      echo "‚öôÔ∏è Configurando vari√°veis de ambiente"
                      echo "========================================="

                      cat > "${{ env.DEPLOY_DIR }}/.env" << 'ENV_EOF'
                      DATABASE_URL=${{ secrets.DATABASE_URL }}
                      REDIS_URL=${{ secrets.REDIS_URL }}
                      NODE_ENV=production
                      NEXT_TELEMETRY_DISABLED=1
                      NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
                      POSTGRES_USER=${{ secrets.POSTGRES_USER }}
                      POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
                      POSTGRES_DB=${{ secrets.POSTGRES_DB }}
                      MERCADOPAGO_ACCESS_TOKEN=${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
                      MERCADOPAGO_PUBLIC_KEY=${{ secrets.MERCADOPAGO_PUBLIC_KEY }}
                      ENV_EOF

                      echo "‚úÖ Arquivo .env criado e protegido"
                      chmod 600 "${{ env.DEPLOY_DIR }}/.env"
                      echo "========================================="

    # Job 6: Blue-Green Deployment - Preparar novo ambiente
    prepare-new-deployment:
        name: Prepare New Deployment (Blue-Green)
        runs-on: ubuntu-latest
        timeout-minutes: 20
        needs: setup-environment

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Prepare new environment
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  timeout: 5m
                  command_timeout: 20m
                  script: |
                      set -euo pipefail
                      echo "========================================="
                      echo "üü¶ Blue-Green: Preparando novo ambiente"
                      echo "========================================="

                      cd "${{ env.DEPLOY_DIR }}"

                      # Parar containers antigos
                      echo "üõë Parando containers antigos..."
                      docker compose down --remove-orphans 2>/dev/null || echo "‚ÑπÔ∏è Nenhum container ativo"

                      # Limpar recursos Docker
                      echo "üßπ Limpando recursos Docker..."
                      docker system prune -f || true

                      # Build nova vers√£o
                      echo "üî® Buildando nova vers√£o..."
                      if ! docker compose up -d --build; then
                          echo "‚ùå Falha no build!"
                          docker compose logs --tail=50
                          exit 1
                      fi

                      echo "‚úÖ Novo ambiente preparado"
                      echo "========================================="

    # Job 7: Health checks e valida√ß√£o
    health-checks:
        name: Health Checks and Validation
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: prepare-new-deployment

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run health checks
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  timeout: 3m
                  command_timeout: 15m
                  script: |
                      set -euo pipefail
                      echo "========================================="
                      echo "üè• Executando health checks"
                      echo "========================================="

                      cd "${{ env.DEPLOY_DIR }}"

                      # Aguardar PostgreSQL
                      echo "‚è≥ Aguardando PostgreSQL..."
                      for i in {1..18}; do
                          sleep 5
                          if docker exec terralsocial-postgres pg_isready -U ${{ secrets.POSTGRES_USER }} &> /dev/null; then
                              echo "‚úÖ PostgreSQL pronto ap√≥s $((i*5))s"
                              break
                          fi
                      done

                      # Aguardar Next.js
                      echo "‚è≥ Aguardando Next.js..."
                      sleep 30

                      # Verificar status dos containers
                      echo ""
                      echo "üìä Status dos containers:"
                      docker compose ps

                      # Executar migrations
                      echo ""
                      echo "üóÑÔ∏è Executando migrations..."
                      docker exec terralsocial-nextjs npx prisma db push --skip-generate 2>&1 || true

                      # Validar aplica√ß√£o
                      echo ""
                      echo "üåê Validando aplica√ß√£o..."
                      MAX_ATTEMPTS=12
                      ATTEMPT=0
                      while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
                          if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
                              echo "‚úÖ Aplica√ß√£o respondendo corretamente"
                              break
                          fi
                          ATTEMPT=$((ATTEMPT + 1))
                          echo "‚è≥ Tentativa $ATTEMPT/$MAX_ATTEMPTS..."
                          sleep 5
                      done

                      if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                          echo "‚ùå Aplica√ß√£o n√£o respondeu ap√≥s $((MAX_ATTEMPTS * 5))s"
                          exit 1
                      fi

                      echo "========================================="
                      echo "‚úÖ Todos os health checks passaram!"
                      echo "========================================="

    # Job 8: Testes p√≥s-deploy
    post-deployment-tests:
        name: Post-Deployment Tests
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: health-checks

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run smoke tests
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  timeout: 2m
                  command_timeout: 10m
                  script: |
                      set -euo pipefail
                      echo "========================================="
                      echo "üß™ Executando smoke tests"
                      echo "========================================="

                      BASE_URL="http://localhost:3000"

                      # Test 1: Home page
                      echo "üìÑ Testando p√°gina inicial..."
                      if curl -f -s "$BASE_URL/" | grep -q "Terral"; then
                          echo "‚úÖ P√°gina inicial OK"
                      else
                          echo "‚ö†Ô∏è P√°gina inicial pode ter problemas"
                      fi

                      # Test 2: API health
                      echo "üîå Testando API..."
                      if curl -f -s "$BASE_URL/api/volunteers" > /dev/null 2>&1; then
                          echo "‚úÖ API respondendo"
                      else
                          echo "‚ö†Ô∏è API pode ter problemas"
                      fi

                      # Test 3: Database connectivity
                      echo "üíæ Testando conectividade com banco..."
                      if docker exec terralsocial-nextjs npx prisma db execute --stdin < /dev/null 2>&1 || true; then
                          echo "‚úÖ Banco de dados acess√≠vel"
                      fi

                      echo "========================================="

    # Job 9: Notifica√ß√£o e conclus√£o
    deployment-complete:
        name: Deployment Complete
        runs-on: ubuntu-latest
        timeout-minutes: 10
        if: success()
        needs:
            [
                pre-deployment-checks,
                database-backup,
                check-prerequisites,
                update-repository,
                setup-environment,
                prepare-new-deployment,
                health-checks,
                post-deployment-tests,
            ]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Get deployment info
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  timeout: 2m
                  command_timeout: 5m
                  script: |
                      set -euo pipefail
                      cd "${{ env.DEPLOY_DIR }}"
                      COMMIT=$(git rev-parse HEAD)

                      echo "========================================="
                      echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
                      echo "========================================="
                      echo "üì¶ Commit: ${COMMIT:0:7}"
                      echo "üìÖ Data: $(date '+%Y-%m-%d %H:%M:%S')"
                      echo "üåê URL: http://${{ secrets.VPS_HOST }}:3000"
                      echo "üíæ Backup ID: ${{ needs.pre-deployment-checks.outputs.backup-id }}"
                      echo "========================================="

            - name: Create successful deployment
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.repos.createDeploymentStatus({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          deployment_id: context.payload.deployment.id,
                          state: 'success',
                          description: 'Deployment completed successfully'
                      })

    # Job 10: Rollback autom√°tico em caso de falha
    deployment-rollback:
        name: Rollback Deployment
        runs-on: ubuntu-latest
        timeout-minutes: 15
        if: failure() && (needs.health-checks.result == 'failure' || needs.post-deployment-tests.result == 'failure')
        needs:
            [
                pre-deployment-checks,
                database-backup,
                check-prerequisites,
                update-repository,
                setup-environment,
                prepare-new-deployment,
                health-checks,
                post-deployment-tests,
            ]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Rollback deployment
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  port: 22
                  timeout: 5m
                  command_timeout: 15m
                  script: |
                      set -euo pipefail
                      echo "========================================="
                      echo "üîÑ INICIANDO ROLLBACK!"
                      echo "========================================="

                      cd "${{ env.DEPLOY_DIR }}"

                      # Parar containers
                      echo "üõë Parando containers..."
                      docker compose down --remove-orphans 2>/dev/null || true

                      # Voltar para commit anterior
                      echo "‚èÆÔ∏è Voltando para vers√£o anterior..."
                      git reset --hard HEAD~1

                      # Reiniciar servi√ßos
                      echo "‚ñ∂Ô∏è Reiniciando servi√ßos..."
                      docker compose up -d --build

                      # Aguardar
                      sleep 30

                      # Validar
                      if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
                          echo "‚úÖ Rollback bem-sucedido!"
                      else
                          echo "‚ùå Rollback falhou! Interven√ß√£o manual necess√°ria!"
                          exit 1
                      fi

                      echo "========================================="

            - name: Create failed deployment
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.repos.createDeploymentStatus({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          deployment_id: context.payload.deployment.id,
                          state: 'failure',
                          description: 'Deployment failed and rolled back'
                      })

            - name: Notify failure
              run: |
                  echo "========================================="
                  echo "‚ùå DEPLOY FALHOU E FOI REVERTIDO!"
                  echo "========================================="
                  echo "‚ùå Deploy falhou ap√≥s testes"
                  echo "üîÑ Rollback executado com sucesso"
                  echo "üìã Verifique os logs acima"
                  echo "üìß Notifica√ß√£o ser√° enviada ao time"
                  echo "========================================="
